<div class="admin-page">
  <div class="admin-header">
    <h2>Tags & Tag Groups</h2>
  </div>

  <div class="tags-layout">
    <div class="taggroups-section">
      <div class="section-header">
        <h3>Tag Groups</h3>
        <button
          pButton
          type="button"
          icon="pi pi-plus"
          class="p-button-sm"
          (click)="openCreateTagGroupDialog()"
          pTooltip="Create Tag Group"
          tooltipPosition="top"
          aria-label="Create tag group"
        ></button>
      </div>

      <div class="search-box">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input
            pInputText
            type="text"
            [(ngModel)]="searchQuery"
            (input)="onSearch()"
            placeholder="Search tag groups..."
            class="search-input"
          />
        </span>
      </div>

      <div class="taggroups-list">
        <div
          class="taggroup-item"
          [class.selected]="showingUngrouped()"
          (click)="selectUngrouped()"
          (keydown.enter)="selectUngrouped()"
          tabindex="0"
          role="button"
          aria-label="Select Ungrouped Tags"
        >
          <div class="taggroup-info">
            <i class="pi pi-tag taggroup-icon"></i>
            <div class="taggroup-details">
              <span class="taggroup-name">Ungrouped Tags</span>
              <span class="taggroup-meta">Tags without a group</span>
            </div>
          </div>
        </div>

        @if (tagGroups().length > 0) {
          @for (tagGroup of tagGroups(); track tagGroup.id) {
            <div
              class="taggroup-item"
              [class.selected]="selectedTagGroup()?.id === tagGroup.id && !showingUngrouped()"
              (click)="selectTagGroup(tagGroup)"
              (keydown.enter)="selectTagGroup(tagGroup)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Select ' + tagGroup.name"
            >
              <div class="taggroup-info">
                <i [class]="'pi pi-' + tagGroup.icon" class="taggroup-icon"></i>
                <div class="taggroup-details">
                  <span class="taggroup-name">{{ tagGroup.name }}</span>
                  <span class="taggroup-meta">{{ tagGroup.tags.length }} tags Â· {{ getVisibilityLabel(tagGroup.visibility) }}</span>
                </div>
              </div>
              <div class="taggroup-actions" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="presentation">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm"
                  (click)="openEditTagGroupDialog(tagGroup)"
                  pTooltip="Edit"
                  tooltipPosition="top"
                  aria-label="Edit tag group"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-sm p-button-danger"
                  (click)="deleteTagGroup(tagGroup)"
                  pTooltip="Delete"
                  tooltipPosition="top"
                  aria-label="Delete tag group"
                ></button>
              </div>
            </div>
          }
        } @else {
          <div class="empty-state">
            <i class="pi pi-tags"></i>
            <p>No tag groups found</p>
          </div>
        }
      </div>
    </div>

    <div class="tags-section">
      @if (showingUngrouped()) {
        <div class="section-header">
          <div class="section-title">
            <h3>Ungrouped Tags</h3>
            <span class="tag-count">{{ ungroupedTags().length }} {{ ungroupedTags().length === 1 ? 'tag' : 'tags' }}</span>
          </div>
          <button
            pButton
            type="button"
            label="Add Tag"
            icon="pi pi-plus"
            class="p-button-sm"
            (click)="openAddUngroupedTagDialog()"
            aria-label="Add ungrouped tag"
          ></button>
        </div>

        <div class="tags-grid">
          @if (ungroupedTags().length > 0) {
            @for (tag of ungroupedTags(); track tag.id) {
              <div class="tag-card"
                   [style.--tag-color]="tag.color || 'var(--p-primary-color)'"
                   [style.background-image]="tag.backgroundImage ? 'url(' + tag.backgroundImage + ')' : 'none'"
                   [class.has-background]="!!tag.backgroundImage">
                <div class="tag-card-color-bar"></div>
                <div class="tag-card-content">
                  <div class="tag-card-header">
                    <div class="tag-icon-wrapper">
                      <i [class]="'pi pi-' + (tag.icon || 'tag')" class="tag-icon"></i>
                    </div>
                    <span class="tag-name">{{ tag.name }}</span>
                  </div>
                  <div class="tag-card-actions">
                    <button
                      pButton
                      type="button"
                      icon="pi pi-pencil"
                      class="p-button-text p-button-sm"
                      (click)="openEditTagDialog(tag)"
                      pTooltip="Edit"
                      tooltipPosition="top"
                      aria-label="Edit tag"
                    ></button>
                    <button
                      pButton
                      type="button"
                      icon="pi pi-plus"
                      class="p-button-text p-button-sm"
                      (click)="openAddToGroupDialog(tag)"
                      pTooltip="Add to Group"
                      tooltipPosition="top"
                      aria-label="Add tag to group"
                    ></button>
                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      class="p-button-text p-button-sm p-button-danger"
                      (click)="deleteTag(tag)"
                      pTooltip="Delete"
                      tooltipPosition="top"
                      aria-label="Delete tag"
                    ></button>
                  </div>
                </div>
              </div>
            }
          } @else {
            <div class="empty-state">
              <i class="pi pi-tag"></i>
              <p>No ungrouped tags</p>
            </div>
          }
        </div>
      } @else if (selectedTagGroup(); as tagGroup) {
        <div class="section-header">
          <div class="section-title">
            <h3>Tags in {{ tagGroup.name }}</h3>
            <span class="tag-count">{{ tagGroup.tags.length }} {{ tagGroup.tags.length === 1 ? 'tag' : 'tags' }}</span>
          </div>
          <button
            pButton
            type="button"
            label="Add Tag"
            icon="pi pi-plus"
            class="p-button-sm"
            (click)="openAddTagDialog()"
            aria-label="Add tag"
          ></button>
        </div>

        <div class="tags-grid">
          @if (tagGroup.tags.length > 0) {
            @for (tag of tagGroup.tags; track tag.id) {
              <div class="tag-card"
                   [style.--tag-color]="tag.color || 'var(--p-primary-color)'"
                   [style.background-image]="tag.backgroundImage ? 'url(' + tag.backgroundImage + ')' : 'none'"
                   [class.has-background]="!!tag.backgroundImage">
                <div class="tag-card-color-bar"></div>
                <div class="tag-card-content">
                  <div class="tag-card-header">
                    <div class="tag-icon-wrapper">
                      <i [class]="'pi pi-' + (tag.icon || 'tag')" class="tag-icon"></i>
                    </div>
                    <span class="tag-name">{{ tag.name }}</span>
                  </div>
                  <div class="tag-card-actions">
                    <button
                      pButton
                      type="button"
                      icon="pi pi-pencil"
                      class="p-button-text p-button-sm"
                      (click)="openEditTagDialog(tag)"
                      pTooltip="Edit"
                      tooltipPosition="top"
                      aria-label="Edit tag"
                    ></button>
                    <button
                      pButton
                      type="button"
                      icon="pi pi-plus"
                      class="p-button-text p-button-sm p-button-success"
                      (click)="openAddToGroupDialog(tag)"
                      pTooltip="Add to Another Group"
                      tooltipPosition="top"
                      aria-label="Add tag to another group"
                    ></button>
                    <button
                      pButton
                      type="button"
                      icon="pi pi-minus"
                      class="p-button-text p-button-sm p-button-warning"
                      (click)="removeFromGroup(tag)"
                      pTooltip="Remove from This Group"
                      tooltipPosition="top"
                      aria-label="Remove tag from this group"
                    ></button>
                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      class="p-button-text p-button-sm p-button-danger"
                      (click)="deleteTag(tag)"
                      pTooltip="Delete Tag"
                      tooltipPosition="top"
                      aria-label="Delete tag"
                    ></button>
                  </div>
                </div>
              </div>
            }
          } @else {
            <div class="empty-state">
              <i class="pi pi-tag"></i>
              <p>No tags yet</p>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <i class="pi pi-arrow-left"></i>
          <p>Select a tag group to view its tags</p>
        </div>
      }
    </div>
  </div>

  <p-dialog
    [(visible)]="dialogVisible"
    [header]="editMode() ? 'Edit Tag Group' : 'Create Tag Group'"
    [modal]="true"
    (onHide)="onDialogHide()"
  >
    <ng-template pTemplate="content">
      <div class="form-group">
        <label for="taggroup-name">Name *</label>
        <input
          pInputText
          id="taggroup-name"
          [(ngModel)]="tagGroupForm().name"
          placeholder="Enter tag group name"
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label for="taggroup-icon">Icon *</label>
        <p-select
          inputId="taggroup-icon"
          [options]="iconOptions"
          [(ngModel)]="tagGroupForm().icon"
          optionLabel="label"
          optionValue="value"
          placeholder="Select an icon"
          appendTo="body"
          [style]="{ width: '100%' }"
        >
          <ng-template pTemplate="selectedItem" let-option>
            <div class="icon-option">
              <i [class]="'pi ' + option.icon"></i>
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-option>
            <div class="icon-option">
              <i [class]="'pi ' + option.icon"></i>
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
        </p-select>
      </div>

      <div class="form-group">
        <label for="taggroup-visibility">Visibility *</label>
        <p-select
          inputId="taggroup-visibility"
          [options]="visibilityOptions"
          [(ngModel)]="tagGroupForm().visibility"
          optionLabel="label"
          optionValue="value"
          placeholder="Select visibility"
          appendTo="body"
          [style]="{ width: '100%' }"
        ></p-select>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancel" class="p-button-text" (click)="closeDialog()"></button>
      <button pButton type="button" [label]="editMode() ? 'Update' : 'Create'" (click)="saveTagGroup()"></button>
    </ng-template>
  </p-dialog>

  <p-dialog
    [(visible)]="tagDialogVisible"
    [header]="editingTag() ? 'Edit Tag' : 'Add Tag'"
    [modal]="true"
    (onHide)="onTagDialogHide()"
  >
    <ng-template pTemplate="content">
      <div class="form-group">
        <label for="tag-name">Name *</label>
        <input
          pInputText
          id="tag-name"
          [(ngModel)]="tagForm().name"
          placeholder="Enter tag name"
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label for="tag-icon">Icon</label>
        <p-select
          inputId="tag-icon"
          [options]="iconOptions"
          [(ngModel)]="tagForm().icon"
          optionLabel="label"
          optionValue="value"
          placeholder="Select an icon"
          appendTo="body"
          [style]="{ width: '100%' }"
        >
          <ng-template pTemplate="selectedItem" let-option>
            <div class="icon-option">
              <i [class]="'pi ' + option.icon"></i>
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-option>
            <div class="icon-option">
              <i [class]="'pi ' + option.icon"></i>
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
        </p-select>
      </div>

      <div class="form-group">
        <label for="tag-color">Color</label>
        <div class="color-picker-container">
          <p-colorPicker
            inputId="tag-color"
            [(ngModel)]="tagForm().color"
            [inline]="false"
            appendTo="body"
          ></p-colorPicker>
          <input
            pInputText
            type="text"
            [(ngModel)]="tagForm().color"
            placeholder="#FF0000"
            class="color-input"
            maxlength="7"
          />
        </div>
        <small>Click the color box or enter a hex color code</small>
      </div>

      <div class="form-group">
        <label for="tag-background">Background Image</label>
        <input
          pInputText
          id="tag-background"
          [(ngModel)]="tagForm().backgroundImage"
          placeholder="https://example.com/image.jpg"
          class="form-input"
        />
        <small>URL to a background image (optional)</small>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancel" class="p-button-text" (click)="closeTagDialog()"></button>
      <button pButton type="button" [label]="editingTag() ? 'Update' : 'Add'" (click)="saveTag()"></button>
    </ng-template>
  </p-dialog>

  <p-dialog
    [(visible)]="addToGroupDialogVisible"
    header="Add Tag to Group"
    [modal]="true"
    (onHide)="closeAddToGroupDialog()"
  >
    <ng-template pTemplate="content">
      <div class="form-group">
        <label for="select-group">Select Tag Groups *</label>
        @if (availableGroupsForTag().length > 0) {
          <p-multiselect
            inputId="select-group"
            [options]="availableGroupsForTag()"
            [(ngModel)]="selectedGroupIds"
            optionLabel="name"
            optionValue="id"
            placeholder="Select one or more groups"
            appendTo="body"
            [style]="{ width: '100%' }"
          >
          <ng-template pTemplate="item" let-option>
            <div class="icon-option">
              <i [class]="'pi pi-' + option.icon"></i>
              <span>{{ option.name }}</span>
            </div>
          </ng-template>
        </p-multiselect>
        } @else {
          <p class="text-muted">This tag is already in all available groups.</p>
        }
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancel" class="p-button-text" (click)="closeAddToGroupDialog()"></button>
      <button pButton type="button" [label]="selectedGroupIds().length > 0 ? 'Add to ' + selectedGroupIds().length + ' Group' + (selectedGroupIds().length === 1 ? '' : 's') : 'Add to Groups'" (click)="addToGroup()"></button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog />
  <p-toast />
</div>
