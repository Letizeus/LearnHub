<div class="admin-page">
  <div class="admin-header">
    <h2>Courses</h2>
  </div>

  <div class="page-card">
    <!-- Filters Toolbar -->
    <div class="filters-toolbar">
      <div class="search-box">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input
            pInputText
            type="text"
            [(ngModel)]="searchQuery"
            (keyup.enter)="onFilterChange()"
            placeholder="Search courses by title..."
            class="search-input"
          />
        </span>
        <button
          pButton
          type="button"
          label="Search"
          icon="pi pi-search"
          (click)="onFilterChange()"
          class="search-button"
          aria-label="Search courses"
        ></button>
      </div>

      <div class="filter-group">
        <label for="status-filter">Status:</label>
        <p-select
          inputId="status-filter"
          [options]="statusOptions"
          [(ngModel)]="statusFilter"
          (ngModelChange)="onFilterChange()"
          optionLabel="label"
          optionValue="value"
          [style]="{ width: '180px' }"
        ></p-select>
      </div>
    </div>

    <!-- Courses Table -->
    <p-table
      [value]="courses()"
      [lazy]="true"
      [paginator]="true"
      [rows]="rowsPerPage()"
      [totalRecords]="totalRecords()"
      [rowsPerPageOptions]="[10, 20, 50]"
      (onPage)="onPageChange($any($event))"
      (onSort)="onSort($any($event))"
      [sortField]="'createdAt'"
      [sortOrder]="-1"
      class="courses-table"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="title">
            Title <p-sortIcon field="title"></p-sortIcon>
          </th>
          <th pSortableColumn="author">
            Author <p-sortIcon field="author"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Status <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th>Content Items</th>
          <th pSortableColumn="changedAt">
            Last Updated <p-sortIcon field="changedAt"></p-sortIcon>
          </th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-course>
        <tr>
          <td>{{ course.title }}</td>
          <td>
            @if (course.author) {
            {{ course.author }}
            } @else {
            <span class="text-muted">Unknown</span>
            }
          </td>
          <td>
            <span [class]="'status-badge ' + getStatusClass(course.status)">
              {{ getStatusLabel(course.status) }}
            </span>
          </td>
          <td>{{ course.contentIds?.length || 0 }}</td>
          <td>
            @if (course.changedAt) {
            {{ course.changedAt | date : 'short' }}
            } @else {
            <span class="text-muted">Unknown</span>
            }
          </td>
          <td>
            <div class="action-buttons">
              <button
                pButton
                type="button"
                icon="pi pi-eye"
                class="p-button-text p-button-sm"
                (click)="viewCourse(course)"
                pTooltip="View Details"
                tooltipPosition="top"
                aria-label="View course details"
              ></button>
              <button
                pButton
                type="button"
                icon="pi pi-trash"
                class="p-button-text p-button-sm p-button-danger"
                (click)="deleteCourse(course)"
                pTooltip="Delete Course"
                tooltipPosition="top"
                aria-label="Delete course"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="empty-message">
            <div class="empty-state">
              <i class="pi pi-book empty-icon"></i>
              <p>No courses found</p>
              @if (searchQuery() || statusFilter()) {
              <p class="empty-subtitle">Try adjusting your filters</p>
              }
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Course Detail Drawer -->
  <p-drawer
    [(visible)]="drawerVisible"
    position="right"
    [style]="{ width: '450px' }"
    (onHide)="closeDrawer()"
  >
    <ng-template pTemplate="header">
      <span class="drawer-title">Course Details</span>
    </ng-template>

    <ng-template pTemplate="content">
      @if (selectedCourse(); as course) {
      <div class="course-details">
        <div class="detail-section">
          <h4>Basic Information</h4>
          <div class="detail-row">
            <span class="detail-label">Title:</span>
            <span class="detail-value">{{ course.title }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span [class]="'status-badge ' + getStatusClass(course.status)">
              {{ getStatusLabel(course.status) }}
            </span>
          </div>
          @if (course.author) {
          <div class="detail-row">
            <span class="detail-label">Author:</span>
            <span class="detail-value">{{ course.author }}</span>
          </div>
          }
          <div class="detail-row">
            <span class="detail-label">Content Items:</span>
            <span class="detail-value">{{ course.contentIds?.length || 0 }}</span>
          </div>
        </div>

        @if (course.source) {
        <div class="detail-section">
          <h4>Source</h4>
          @if (course.source.url) {
          <div class="detail-row">
            <span class="detail-label">URL:</span>
            <span class="detail-value">
              <a [href]="course.source.url" target="_blank" rel="noopener">{{
                course.source.url
              }}</a>
            </span>
          </div>
          }
          @if (course.source.publisher) {
          <div class="detail-row">
            <span class="detail-label">Publisher:</span>
            <span class="detail-value">{{ course.source.publisher }}</span>
          </div>
          }
          @if (course.source.organisation) {
          <div class="detail-row">
            <span class="detail-label">Organisation:</span>
            <span class="detail-value">{{ course.source.organisation }}</span>
          </div>
          }
          @if (course.source.publishedAt) {
          <div class="detail-row">
            <span class="detail-label">Published:</span>
            <span class="detail-value">{{
              course.source.publishedAt | date : 'medium'
            }}</span>
          </div>
          }
        </div>
        }

        <div class="detail-section">
          <h4>Timestamps</h4>
          <div class="detail-row">
            <span class="detail-label">Created At:</span>
            <span class="detail-value">
              @if (course.createdAt) {
              {{ course.createdAt | date : 'medium' }}
              } @else {
              <span class="text-muted">Unknown</span>
              }
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Changed At:</span>
            <span class="detail-value">
              @if (course.changedAt) {
              {{ course.changedAt | date : 'medium' }}
              } @else {
              <span class="text-muted">Unknown</span>
              }
            </span>
          </div>
        </div>

        <div class="detail-actions">
          <h4>Actions</h4>
          <button
            pButton
            type="button"
            label="Delete Course"
            icon="pi pi-trash"
            class="p-button-danger p-button-outlined action-btn"
            (click)="deleteCourse(course)"
            aria-label="Delete course"
          ></button>
        </div>
      </div>
      }
    </ng-template>
  </p-drawer>

  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Toast Messages -->
  <p-toast></p-toast>
</div>
